<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Laser Measure Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --bg: #0f172a;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #f8fafc;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .digital { font-family: 'JetBrains+Mono', monospace; }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.08); 
        }
        .btn-active:active { transform: scale(0.96); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Custom animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .signal-pulse::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #ef4444;
            animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <div class="max-w-md w-full px-5 py-6 flex flex-col min-h-screen gap-6">
        
        <!-- App Bar -->
        <header class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="text-white" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight">SmartMeasure</h1>
                    <div id="connState" class="flex items-center gap-1.5 opacity-60">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500" id="statusDot"></span>
                        <span class="text-[10px] font-bold uppercase tracking-wider" id="statusText">Disconnected</span>
                    </div>
                </div>
            </div>
            
            <button id="settingsBtn" class="p-2 glass rounded-full text-slate-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </header>

        <!-- Main Readout Display -->
        <main class="flex flex-col gap-6">
            <section class="glass rounded-[2rem] p-8 flex flex-col items-center justify-center relative shadow-2xl overflow-hidden min-h-[220px]">
                <!-- Background Pulse Effect -->
                <div id="readPulse" class="absolute inset-0 bg-blue-500/10 opacity-0 transition-opacity pointer-events-none"></div>
                
                <div class="absolute top-5 flex items-center gap-2">
                    <span id="protocolBadge" class="text-[10px] font-bold bg-white/10 px-2 py-0.5 rounded border border-white/10 uppercase tracking-widest text-blue-400">Generic Mode</span>
                </div>

                <div id="displayValue" class="text-7xl font-bold digital text-white mb-1 drop-shadow-2xl transition-all duration-300">0.000</div>
                <div id="displayUnit" class="text-sm font-bold text-slate-500 uppercase tracking-widest">meters</div>

                <!-- Signal Indicator -->
                <div id="signalIndicator" class="mt-6 flex items-center gap-2 opacity-0 transition-all scale-90">
                    <div class="relative w-2 h-2 rounded-full bg-red-500 signal-pulse"></div>
                    <span class="text-[10px] font-black text-red-500 uppercase tracking-tighter">Read Successful</span>
                </div>
            </section>

            <!-- Quick Controls -->
            <section class="grid grid-cols-2 gap-3">
                <button id="connectBtn" class="btn-active col-span-2 py-5 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-bold shadow-xl shadow-blue-900/20 flex items-center justify-center gap-3 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="m17 7-5-5-5 5"/><path d="m17 17-5 5-5-5"/></svg>
                    CONNECT DEVICE
                </button>
                
                <button id="unitBtn" class="btn-active glass p-4 rounded-2xl flex flex-col items-center justify-center gap-1">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Unit</span>
                    <span id="unitLabel" class="font-bold text-sm">METERS (m)</span>
                </button>

                <button id="exportBtn" class="btn-active glass p-4 rounded-2xl flex flex-col items-center justify-center gap-1">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Data</span>
                    <span class="font-bold text-sm text-blue-400">EXPORT CSV</span>
                </button>
            </section>

            <!-- Configuration Modal (Hidden by Default) -->
            <div id="configOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center p-4">
                <div class="glass w-full max-w-sm rounded-[2rem] p-6 animate-in slide-in-from-bottom-10">
                    <h3 class="text-lg font-bold mb-4">Device Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Compatibility Profile</label>
                            <select id="profileSelect" class="w-full bg-slate-800 border border-white/10 rounded-xl p-3 text-sm mt-1 outline-none focus:ring-2 ring-blue-500">
                                <option value="generic">Standard (Mileseey/SNDWAY)</option>
                                <option value="bosch">Professional (Bosch GLM)</option>
                                <option value="custom">Advanced (Custom UUID)</option>
                            </select>
                        </div>
                        
                        <div id="customUuidGroup" class="hidden">
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Service UUID</label>
                            <input id="customUuidInput" type="text" placeholder="0000FFE0-..." class="w-full bg-slate-800 border border-white/10 rounded-xl p-3 text-sm mt-1 digital uppercase">
                        </div>
                    </div>

                    <button id="closeConfig" class="w-full mt-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm">SAVE & CLOSE</button>
                </div>
            </div>

            <!-- History List -->
            <section class="flex flex-col flex-grow">
                <div class="flex items-center justify-between px-2 mb-3">
                    <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Recent Measurements</h2>
                    <button id="clearBtn" class="text-[10px] font-bold text-red-500/80 hover:text-red-500 uppercase">Clear All</button>
                </div>
                
                <div id="historyList" class="flex-grow overflow-y-auto scrollbar-hide space-y-2 max-h-[300px]">
                    <div id="emptyMsg" class="h-40 flex items-center justify-center text-slate-600 text-sm italic">
                        No readings logged...
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- UI Feedback Toast -->
    <div id="toast" class="fixed bottom-10 bg-white text-slate-900 px-6 py-3 rounded-full text-xs font-bold shadow-2xl opacity-0 translate-y-10 transition-all duration-300 pointer-events-none z-50"></div>

    <script>
        /**
         * BT PROTOCOL DATABASE
         * Most generic Chinese lasers use the 0xFFE0 / 0xFFE1 Serial-over-BLE profile.
         * Bosch GLM uses a specific proprietary UUID.
         */
        const PROFILES = {
            generic: { service: '0000ffe0-0000-1000-8000-00805f9b34fb', char: '0000ffe1-0000-1000-8000-00805f9b34fb' },
            bosch:   { service: '02a10001-524f-4b49-424f-5343484d5354', char: '02a10002-524f-4b49-424f-5343484d5354' }
        };

        // Application State
        let device = null;
        let characteristic = null;
        let currentUnit = 'm';
        let measurementHistory = [];

        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const displayValue = document.getElementById('displayValue');
        const historyList = document.getElementById('historyList');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const configOverlay = document.getElementById('configOverlay');

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        function setVisualConnection(isConnected) {
            statusDot.className = isConnected ? 'w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'w-1.5 h-1.5 rounded-full bg-red-500';
            statusText.innerText = isConnected ? 'Connected' : 'Disconnected';
            connectBtn.innerText = isConnected ? 'DISCONNECT DEVICE' : 'CONNECT DEVICE';
            connectBtn.className = isConnected ? 'btn-active col-span-2 py-5 bg-slate-800 text-white rounded-2xl font-bold shadow-xl transition-all' : 'btn-active col-span-2 py-5 bg-blue-600 text-white rounded-2xl font-bold shadow-xl shadow-blue-900/20 transition-all';
        }

        /**
         * Main Connection Flow
         * Triggered by user gesture
         */
        async function handleConnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
                return;
            }

            const profileKey = document.getElementById('profileSelect').value;
            let serviceUuid, charUuid;

            if (profileKey === 'custom') {
                serviceUuid = document.getElementById('customUuidInput').value.toLowerCase();
                if (!serviceUuid) return showToast("Enter a Service UUID first");
            } else {
                serviceUuid = PROFILES[profileKey].service;
                charUuid = PROFILES[profileKey].char;
            }

            try {
                showToast("Requesting Bluetooth Device...");
                device = await navigator.bluetooth.requestDevice({
                    filters: profileKey === 'generic' ? undefined : [{ services: [serviceUuid] }],
                    acceptAllDevices: profileKey === 'generic',
                    optionalServices: [serviceUuid]
                });

                showToast("Connecting to GATT Server...");
                const server = await device.gatt.connect();
                
                showToast("Discovering Services...");
                const service = await server.getPrimaryService(serviceUuid);
                
                if (charUuid) {
                    characteristic = await service.getCharacteristic(charUuid);
                } else {
                    // Auto-detect first notify characteristic
                    const chars = await service.getCharacteristics();
                    characteristic = chars.find(c => c.properties.notify || c.properties.indicate);
                }

                if (!characteristic) throw new Error("No data channel found on device");

                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', parseDataPacket);
                
                device.addEventListener('gattserverdisconnected', () => setVisualConnection(false));
                
                setVisualConnection(true);
                showToast("Connection Established!");
                document.getElementById('protocolBadge').innerText = profileKey + " mode";

            } catch (err) {
                console.error(err);
                showToast(err.message.includes("User cancelled") ? "Pairing cancelled" : "Error: " + err.message);
            }
        }

        /**
         * Smart Parser
         * Handles both String-based ASCII and Binary data
         */
        function parseDataPacket(event) {
            const value = event.target.value;
            
            // 1. Trigger UI visual feedback
            const pulse = document.getElementById('readPulse');
            const signal = document.getElementById('signalIndicator');
            pulse.classList.add('opacity-100');
            signal.classList.add('opacity-100', 'scale-100');
            setTimeout(() => {
                pulse.classList.remove('opacity-100');
                signal.classList.remove('opacity-100', 'scale-100');
            }, 800);

            let meters = null;

            // Strategy A: ASCII Decoding (Most generic lasers)
            // Expecting something like "1.234m" or "5.678"
            const rawString = new TextDecoder().decode(value).trim();
            const stringMatches = rawString.match(/[0-9]+\.[0-9]+/);
            if (stringMatches) {
                meters = parseFloat(stringMatches[0]);
            }

            // Strategy B: Binary Decoding (Professional tools)
            // Often sends a 4-byte Float32
            if (meters === null || meters === 0) {
                try {
                    // Common offset for Bosch distance values
                    const f32 = value.getFloat32(1, true);
                    if (f32 > 0.01 && f32 < 100) meters = f32;
                } catch(e) {}
            }

            if (meters !== null && !isNaN(meters)) {
                processReading(meters);
            }
        }

        function processReading(meters) {
            let val = meters;
            if (currentUnit === 'ft') val = meters * 3.28084;
            if (currentUnit === 'in') val = meters * 39.3701;

            const formatted = val.toFixed(3);
            displayValue.innerText = formatted;
            
            const entry = {
                val: formatted,
                unit: currentUnit,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
            };
            
            measurementHistory.unshift(entry);
            renderHistory();
        }

        function renderHistory() {
            const empty = document.getElementById('emptyMsg');
            if (measurementHistory.length > 0) empty.classList.add('hidden');
            
            historyList.innerHTML = '';
            measurementHistory.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'glass bg-white/5 flex items-center justify-between p-4 rounded-xl border-white/5 animate-in fade-in slide-in-from-left-2';
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-[9px] font-bold text-slate-500 uppercase">${item.time}</span>
                        <div class="digital text-xl font-bold">
                            ${item.val} <span class="text-[10px] text-blue-500 font-black ml-1 uppercase">${item.unit}</span>
                        </div>
                    </div>
                    <button onclick="copyReading('${item.val}')" class="p-3 text-slate-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                    </button>
                `;
                historyList.appendChild(div);
            });
        }

        window.copyReading = (v) => {
            const el = document.createElement('textarea');
            el.value = v;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("Copied to clipboard");
        };

        // UI Event Handlers
        connectBtn.addEventListener('click', handleConnect);

        document.getElementById('unitBtn').addEventListener('click', () => {
            const units = ['m', 'ft', 'in'];
            const labels = { m: 'METERS (m)', ft: 'FEET (ft)', in: 'INCHES (in)' };
            currentUnit = units[(units.indexOf(currentUnit) + 1) % units.length];
            document.getElementById('unitLabel').innerText = labels[currentUnit];
            document.getElementById('displayUnit').innerText = currentUnit === 'm' ? 'meters' : currentUnit === 'ft' ? 'feet' : 'inches';
            showToast(`Switched to ${labels[currentUnit]}`);
        });

        document.getElementById('settingsBtn').addEventListener('click', () => configOverlay.classList.remove('hidden'));
        document.getElementById('closeConfig').addEventListener('click', () => configOverlay.classList.add('hidden'));

        document.getElementById('profileSelect').addEventListener('change', (e) => {
            document.getElementById('customUuidGroup').classList.toggle('hidden', e.target.value !== 'custom');
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            measurementHistory = [];
            renderHistory();
            displayValue.innerText = "0.000";
            document.getElementById('emptyMsg').classList.remove('hidden');
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (measurementHistory.length === 0) return showToast("No data to export");
            const csv = "Time,Value,Unit\n" + measurementHistory.map(h => `${h.time},${h.val},${h.unit}`).join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `measurements_${Date.now()}.csv`;
            a.click();
        });

        // Initial Feature Check
        window.onload = () => {
            if (!navigator.bluetooth) {
                connectBtn.disabled = true;
                connectBtn.classList.replace('bg-blue-600', 'bg-red-900/50');
                connectBtn.innerText = "BT NOT SUPPORTED";
                showToast("Use Chrome/Edge on Desktop or Android.");
            }
        };
    </script>
</body>
</html>

